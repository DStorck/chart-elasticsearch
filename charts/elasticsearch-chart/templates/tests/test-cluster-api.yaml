apiVersion: v1
kind: Pod
metadata:
  name: {{ printf "%s-%s" .Release.Name "clusterapitest" | trunc 63 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  # Test the elasticsearch cluster api: 
  #   https://www.elastic.co/guide/en/elasticsearch/reference/5.2/cluster-health.html
  containers:
  - name: {{ printf "%s-%s" .Release.Name "clusterapitest" | trunc 63 }}
    image: {{ .Values.test_image }}
    command: ["/bin/sh", "-c", "for i in 1 2 3 4 5; do curl http://{{ .Values.name }}.{{ .Release.Namespace }}:{{ .Values.port }}/_cluster/health ; sleep 600 ; done"]
  restartPolicy: Never
